<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gemini Sheet Builder ‚Äî –í–µ–±</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: #f3f4f6;
      }
      body {
        margin: 0;
        padding: 0 24px 48px;
        color: #0f172a;
      }
      h1 {
        font-size: 32px;
        margin: 24px 0 8px;
      }
      p.subtitle {
        margin-top: 0;
        color: #475569;
      }
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        padding: 20px;
        margin-bottom: 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }
      input[type="text"],
      input[type="password"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        box-sizing: border-box;
      }
      textarea {
        resize: vertical;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
      }
      .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 16px;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
      }
      .button.secondary {
        background: #e2e8f0;
        color: #0f172a;
        box-shadow: none;
      }
      .button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .header-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        color: #0f172a;
        background: #e2e8f0;
      }
      .badge.success { background: #dcfce7; color: #166534; }
      .badge.ready { background: #dcfce7; color: #166534; }
      .badge.error { background: #fee2e2; color: #991b1b; }
      .badge.generating { background: #e0f2fe; color: #075985; }
      .badge.regenerating { background: #ede9fe; color: #5b21b6; }
      .badge.approved { background: #fef9c3; color: #92400e; }
      .sheet-prompt {
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        border: 1px dashed #e2e8f0;
      }
      .sheet-prompt h4 {
        margin: 0 0 6px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #475569;
      }
      .sheet-prompt p {
        margin: 0;
        color: #0f172a;
        white-space: pre-wrap;
        line-height: 1.5;
      }
      .preview img {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
      }
      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
      }
      .preview .placeholder {
        width: 100%;
        padding: 32px;
        text-align: center;
        color: #94a3b8;
        border-radius: 12px;
        border: 1px dashed #cbd5e1;
        background: #f8fafc;
      }
      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 10px 0;
      }
      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        background: #e2e8f0;
        font-size: 12px;
        color: #334155;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 12px;
      }
      .flash {
        padding: 12px 16px;
        border-radius: 10px;
        margin: 10px 0;
        font-weight: 600;
      }
      .flash.success { background: #dcfce7; color: #166534; }
      .flash.error { background: #fee2e2; color: #991b1b; }
      .progress {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .progress-bar {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: #e2e8f0;
        overflow: hidden;
      }
      .progress-bar span {
        display: block;
        height: 100%;
        background: linear-gradient(135deg, #22c55e, #16a34a);
      }
      .status-note {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 10px;
        background: #f8fafc;
        color: #0f172a;
      }
    </style>
  </head>
  <body>
    <h1>–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ Gemini</h1>
    <p class="subtitle">–†–∞–∑–±–µ–π—Ç–µ –ø—Ä–æ–º—Ç –Ω–∞ –ª–∏—Å—Ç—ã, –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∏ –æ—Ç–º–µ—á–∞–π—Ç–µ –ª—É—á—à–∏–µ.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div>
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if progress.total %}
      <div class="card" style="margin-bottom: 12px;">
        <div class="progress">
          <div class="header-actions">
            <div>
              <div style="font-weight: 700; font-size: 16px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div>
              <p style="margin: 4px 0 0; color: #475569;">–ì–æ—Ç–æ–≤–æ {{ progress.completed }} –∏–∑ {{ progress.total }} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</p>
            </div>
            {% if progress.active %}
              <span class="badge generating">–í —Ä–∞–±–æ—Ç–µ: {{ progress.active }}</span>
            {% else %}
              <span class="badge ready">–û—á–µ—Ä–µ–¥—å —Å–≤–æ–±–æ–¥–Ω–∞</span>
            {% endif %}
          </div>
          <div class="progress-bar">
            {% set percent = (progress.completed / progress.total * 100) | round(0, 'floor') if progress.total else 0 %}
            <span style="width: {{ percent }}%;"></span>
          </div>
        </div>
      </div>
    {% endif %}

    <form class="card" method="post" action="{{ url_for('update_settings') }}">
      <div class="header-actions">
        <div>
          <h2 style="margin: 0 0 6px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
          <p style="margin: 0; color: #475569;">API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–æ –≤—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</p>
        </div>
        <button class="button secondary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>

      <div class="row">
        <div>
          <label for="saved_api_key">Gemini API key</label>
          <input id="saved_api_key" name="saved_api_key" type="password" placeholder="–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π GEMINI_API_KEY" value="{{ settings.api_key }}">
          <p style="margin: 6px 0 0; color: #64748b; font-size: 13px;">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–æ–ª–µ –≤ —Ñ–æ—Ä–º–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—É—Å—Ç–æ–µ.</p>
        </div>
      </div>
    </form>

    <form class="card" method="post" action="{{ url_for('generate') }}" enctype="multipart/form-data">
      <div class="header-actions">
        <div>
          <h2 style="margin: 0 0 6px;">–ù–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</h2>
          <p style="margin: 0; color: #475569;">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö API –∫–ª—é—á.</p>
        </div>
        <button class="button" type="submit">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
      </div>

      <div class="row">
        <div>
          <label for="api_key">Gemini API key</label>
          <input id="api_key" name="api_key" type="password" placeholder="GEMINI_API_KEY (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value="{{ settings.api_key }}">
        </div>
        <div>
          <label for="aspect_ratio">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω</label>
          <select id="aspect_ratio" name="aspect_ratio">
            {% for ratio in ASPECT_RATIOS %}
              <option value="{{ ratio }}">{{ ratio }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="resolution">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ</label>
          <select id="resolution" name="resolution">
            {% for res in RESOLUTIONS %}
              <option value="{{ res }}">{{ res }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="background_references">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã —Ñ–æ–Ω–∞</label>
          <input id="background_references" name="background_references" type="file" accept="image/*" multiple>
          <p style="margin: 6px 0 0; color: #64748b; font-size: 13px;">–§–æ–Ω–æ–≤—ã–µ –∏–ª–∏ —Ü–≤–µ—Ç–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∫–æ –≤—Å–µ–º –ª–∏—Å—Ç–∞–º.</p>
        </div>
        <div>
          <label for="detail_references">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
          <input id="detail_references" name="detail_references" type="file" accept="image/*" multiple>
          <p style="margin: 6px 0 0; color: #64748b; font-size: 13px;">–û—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–ª–∏ —Å—Ç–∏–ª—å –¥–ª—è –≥–µ—Ä–æ–µ–≤ –∏ –æ–±—ä–µ–∫—Ç–æ–≤.</p>
        </div>
      </div>

      <div id="prompt-blocks" class="grid">
        <div class="block-field">
          <label>–ü—Ä–æ–º—Ç –ª–∏—Å—Ç–∞ 1</label>
          <textarea name="sheet_prompts" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–±—â–∏–π —Å–µ—Ç—Ç–∏–Ω–≥ —Å—Ü–µ–Ω—ã"></textarea>
        </div>
        <div class="block-field">
          <label>–ü—Ä–æ–º—Ç –ª–∏—Å—Ç–∞ 2</label>
          <textarea name="sheet_prompts" rows="3" placeholder="–î–µ—Ç–∞–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Å–≤–µ—Ç–∞ –∏–ª–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã"></textarea>
        </div>
      </div>
      <div style="margin-top: 12px;">
        <button id="add-block" class="button secondary" type="button">+ –î–æ–±–∞–≤–∏—Ç—å –ª–∏—Å—Ç</button>
      </div>
    </form>

    <h2 style="margin: 28px 0 12px;">–ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
    {% if generations %}
      <div class="grid">
        {% for gen in generations %}
          <div class="card">
            <div class="header-actions">
              <div>
                <div style="font-weight: 700; font-size: 16px;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è #{{ gen.id }}</div>
                <div class="chip-row">
                  <span class="chip">{{ gen.aspect_ratio }}</span>
                  <span class="chip">{{ gen.resolution }}</span>
                  {% if gen.approved %}<span class="chip">‚òÖ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å</span>{% endif %}
                </div>
              </div>
              <span class="badge {{ gen.status }}">{{ STATUS_LABELS.get(gen.status, gen.status) }}</span>
            </div>

            {% if gen.status in ['generating', 'regenerating'] %}
              <div class="status-note" style="margin-top: 8px;">
                üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è ‚Äî –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã.
              </div>
            {% endif %}

            <div class="grid" style="margin-top: 8px;">
              <div>
                {% for prompt in gen.sheet_prompts %}
                  <div class="sheet-prompt">
                    <h4>–ü—Ä–æ–º—Ç –ª–∏—Å—Ç–∞ {{ loop.index }}</h4>
                    <p>{{ prompt }}</p>
                  </div>
                {% endfor %}
                {% if gen.background_references %}
                  <div style="margin-top: 12px;">
                    <h4 style="margin: 0 0 6px; font-size: 13px;">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã —Ñ–æ–Ω–∞</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      {% for ref in gen.background_references %}
                        {% set filename = ref.rsplit('/', 1)[-1] %}
                        <a href="{{ url_for('serve_asset', filename=filename) }}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #e2e8f0; color: #0f172a; text-decoration: none; font-size: 12px;">
                          üìé {{ filename }}
                        </a>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
                {% if gen.detail_references %}
                  <div style="margin-top: 12px;">
                    <h4 style="margin: 0 0 6px; font-size: 13px;">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      {% for ref in gen.detail_references %}
                        {% set filename = ref.rsplit('/', 1)[-1] %}
                        <a href="{{ url_for('serve_asset', filename=filename) }}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #e2e8f0; color: #0f172a; text-decoration: none; font-size: 12px;">
                          üìé {{ filename }}
                        </a>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
                {% if gen.text_parts %}
                  <div style="margin-top: 10px;">
                    <h4 style="margin: 0 0 6px; font-size: 13px;">–¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –º–æ–¥–µ–ª–∏</h4>
                    <ul style="margin: 0 0 4px 18px; color: #475569;">
                      {% for text in gen.text_parts %}
                        <li>{{ text }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
            </div>
            <div class="preview">
              {% set images = gen.images %}
              {% if images %}
                <div class="preview-grid">
                  {% for image in images %}
                    {% if image.exists %}
                      <img src="{{ url_for('serve_asset', filename=image.filename) }}" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç –ª–∏—Å—Ç–∞ {{ loop.index }}">
                    {% else %}
                      <div class="placeholder">–§–∞–π–ª {{ image.filename }} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.</div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% else %}
                <div class="placeholder">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</div>
              {% endif %}
            </div>
          </div>

            <div class="actions">
              <form method="post" action="{{ url_for('approve', generation_id=gen.id) }}">
                <button class="button" type="submit" {% if gen.approved %}disabled{% endif %}>üëç –ê–ø—Ä—É–≤</button>
              </form>
              <form method="post" action="{{ url_for('regenerate', generation_id=gen.id) }}" style="display: flex; gap: 8px; align-items: center;">
                <input name="api_key" type="password" placeholder="API key (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value="{{ settings.api_key }}" style="width: 220px;">
                <button class="button secondary" type="submit">‚Üª –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p style="color: #94a3b8;">–ü–æ–∫–∞ –Ω–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–º—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é¬ª.</p>
    {% endif %}

    <script>
      const blocksContainer = document.getElementById('prompt-blocks');
      const addBlockButton = document.getElementById('add-block');

      addBlockButton.addEventListener('click', () => {
        const index = blocksContainer.querySelectorAll('.block-field').length + 1;
        const wrapper = document.createElement('div');
        wrapper.className = 'block-field';
        wrapper.innerHTML = `
          <label>–ü—Ä–æ–º—Ç –ª–∏—Å—Ç–∞ ${index}</label>
          <textarea name="sheet_prompts" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –ª–∏—Å—Ç–∞"></textarea>
        `;
        blocksContainer.appendChild(wrapper);
      });
    </script>
  </body>
</html>
