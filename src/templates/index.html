<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gemini Sheet Builder ‚Äî –í–µ–±</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        background: #f3f4f6;
      }
      body {
        margin: 0;
        padding: 0 24px 48px;
        color: #0f172a;
      }
      h1 {
        font-size: 32px;
        margin: 24px 0 8px;
      }
      p.subtitle {
        margin-top: 0;
        color: #475569;
      }
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
        padding: 20px;
        margin-bottom: 20px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 16px;
      }
      .history {
        display: grid;
        grid-template-columns: 280px 1fr;
        gap: 16px;
        align-items: flex-start;
      }
      .history .card {
        margin-bottom: 0;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }
      input[type="text"],
      input[type="password"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        box-sizing: border-box;
      }
      textarea {
        resize: vertical;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
      }
      .button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 16px;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 8px 20px rgba(37, 99, 235, 0.35);
      }
      .button.secondary {
        background: #e2e8f0;
        color: #0f172a;
        box-shadow: none;
      }
      .button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .header-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        color: #0f172a;
        background: #e2e8f0;
      }
      .badge.success { background: #dcfce7; color: #166534; }
      .badge.ready { background: #dcfce7; color: #166534; }
      .badge.error { background: #fee2e2; color: #991b1b; }
      .badge.generating { background: #e0f2fe; color: #075985; }
      .badge.regenerating { background: #ede9fe; color: #5b21b6; }
      .badge.approved { background: #fef9c3; color: #92400e; }
      .gen-browser {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .gen-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .gen-list button {
        width: 100%;
        text-align: left;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        font-weight: 600;
        color: #0f172a;
      }
      .gen-list button.active {
        background: linear-gradient(135deg, #2563eb0d, #4f46e510);
        border-color: #cbd5e1;
      }
      .sheet-prompt {
        background: #f8fafc;
        border-radius: 10px;
        padding: 12px;
        border: 1px dashed #e2e8f0;
      }
      .sheet-prompt h4 {
        margin: 0 0 6px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #475569;
      }
      .sheet-prompt p {
        margin: 0;
        color: #0f172a;
        white-space: pre-wrap;
        line-height: 1.5;
      }
      .preview img {
        width: 100%;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        background: #f8fafc;
      }
      .preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
      }
      .image-card {
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: #f8fafc;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        padding: 10px;
      }
      .image-card .actions {
        margin-top: 0;
      }
      .preview .placeholder {
        width: 100%;
        padding: 32px;
        text-align: center;
        color: #94a3b8;
        border-radius: 12px;
        border: 1px dashed #cbd5e1;
        background: #f8fafc;
      }
      .preview-grid img {
        width: 100%;
        display: block;
        border-radius: 10px;
        background: #fff;
      }
      .chip-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 10px 0;
      }
      .chip {
        padding: 6px 10px;
        border-radius: 999px;
        background: #e2e8f0;
        font-size: 12px;
        color: #334155;
      }
      .actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 12px;
      }
      .flash {
        padding: 12px 16px;
        border-radius: 10px;
        margin: 10px 0;
        font-weight: 600;
      }
      .flash.success { background: #dcfce7; color: #166534; }
      .flash.error { background: #fee2e2; color: #991b1b; }
      .progress {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .progress-bar {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: #e2e8f0;
        overflow: hidden;
      }
      .progress-bar span {
        display: block;
        height: 100%;
        background: linear-gradient(135deg, #22c55e, #16a34a);
      }
      .status-note {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 10px;
        background: #f8fafc;
        color: #0f172a;
      }
      .hidden-card {
        display: none;
      }
      .button.full-width {
        width: 100%;
        justify-content: center;
      }
      .status-inline {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #475569;
        font-size: 13px;
      }
      .live-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #22c55e;
        display: inline-block;
        box-shadow: 0 0 0 6px #22c55e22;
      }
      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 30;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .lightbox.visible {
        opacity: 1;
        pointer-events: all;
      }
      .lightbox img {
        max-width: min(90vw, 1200px);
        max-height: 90vh;
        border-radius: 12px;
        box-shadow: 0 20px 80px rgba(0, 0, 0, 0.4);
      }
      .lightbox .close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: #0f172a;
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        font-size: 18px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ Gemini</h1>
    <p class="subtitle">–†–∞–∑–±–µ–π—Ç–µ –ø—Ä–æ–º—Ç –Ω–∞ –ª–∏—Å—Ç—ã, –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –∏ –æ—Ç–º–µ—á–∞–π—Ç–µ –ª—É—á—à–∏–µ.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div>
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if progress.total %}
      <div class="card" style="margin-bottom: 12px;">
        <div class="progress">
          <div class="header-actions">
            <div>
              <div style="font-weight: 700; font-size: 16px;">–ü—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div>
              <p style="margin: 4px 0 0; color: #475569;">–ì–æ—Ç–æ–≤–æ <span id="progress-completed">{{ progress.completed }}</span> –∏–∑ <span id="progress-total">{{ progress.total }}</span> –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.</p>
            </div>
            {% if progress.active %}
              <span id="progress-active" class="badge generating">–í —Ä–∞–±–æ—Ç–µ: {{ progress.active }}</span>
            {% else %}
              <span id="progress-active" class="badge ready">–û—á–µ—Ä–µ–¥—å —Å–≤–æ–±–æ–¥–Ω–∞</span>
            {% endif %}
          </div>
          <div class="progress-bar">
            {% set percent = (progress.completed / progress.total * 100) | round(0, 'floor') if progress.total else 0 %}
            <span id="progress-bar" style="width: {{ percent }}%;"></span>
          </div>
        </div>
      </div>
    {% endif %}

    <form class="card" method="post" action="{{ url_for('update_settings') }}">
      <div class="header-actions">
        <div>
          <h2 style="margin: 0 0 6px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
          <p style="margin: 0; color: #475569;">API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–æ –≤—Å–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</p>
        </div>
        <button class="button secondary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
      </div>

      <div class="row">
        <div>
          <label for="saved_api_key">Gemini API key</label>
          <input id="saved_api_key" name="saved_api_key" type="password" placeholder="–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π GEMINI_API_KEY" value="{{ settings.api_key }}">
          <p style="margin: 6px 0 0; color: #64748b; font-size: 13px;">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–æ–ª–µ –≤ —Ñ–æ—Ä–º–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—É—Å—Ç–æ–µ.</p>
        </div>
      </div>
    </form>

    <form class="card" method="post" action="{{ url_for('generate') }}" enctype="multipart/form-data">
      <div class="header-actions">
        <div>
          <h2 style="margin: 0 0 6px;">–ù–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</h2>
          <p style="margin: 0; color: #475569;">–ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–µ –ø—É—Å—Ç—ã–º, –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö API –∫–ª—é—á.</p>
        </div>
        <button class="button" type="submit" id="start-generation" {% if progress.active %}disabled{% endif %}>–ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é</button>
      </div>
      <div id="form-live-status" class="status-note" style="display: none; margin: 8px 0 0;">
        ‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
      </div>

      <div class="row">
        <div>
          <label for="api_key">Gemini API key</label>
          <input id="api_key" name="api_key" type="password" placeholder="GEMINI_API_KEY (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value="{{ settings.api_key }}">
        </div>
        <div>
          <label for="aspect_ratio">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω</label>
          <select id="aspect_ratio" name="aspect_ratio">
            {% for ratio in ASPECT_RATIOS %}
              <option value="{{ ratio }}">{{ ratio }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="resolution">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ</label>
          <select id="resolution" name="resolution">
            {% for res in RESOLUTIONS %}
              <option value="{{ res }}">{{ res }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="background_references">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã —Ñ–æ–Ω–∞</label>
          <input id="background_references" name="background_references" type="file" accept="image/*" multiple>
          <p style="margin: 6px 0 0; color: #64748b; font-size: 13px;">–§–æ–Ω–æ–≤—ã–µ –∏–ª–∏ —Ü–≤–µ—Ç–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–º–µ–Ω—è—Ç—Å—è –∫–æ –≤—Å–µ–º –ª–∏—Å—Ç–∞–º.</p>
        </div>
        <div>
          <label for="detail_references">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
          <input id="detail_references" name="detail_references" type="file" accept="image/*" multiple>
          <p style="margin: 6px 0 0; color: #64748b; font-size: 13px;">–û—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–ª–∏ —Å—Ç–∏–ª—å –¥–ª—è –≥–µ—Ä–æ–µ–≤ –∏ –æ–±—ä–µ–∫—Ç–æ–≤.</p>
        </div>
      </div>

      {% if settings.background_references or settings.detail_references %}
        <div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0;">
          <h3 style="margin: 0 0 8px;">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã</h3>
          <p style="margin: 0 0 10px; color: #475569;">–ë—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –Ω–æ–≤—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é. –î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª—ã –≤—ã—à–µ, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫.</p>
          <div class="row" style="margin-bottom: 0;">
            {% if settings.background_references %}
              <div>
                <h4 style="margin: 0 0 6px; font-size: 13px;">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã —Ñ–æ–Ω–∞</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  {% for ref in settings.background_references %}
                    {% set filename = ref.rsplit('/', 1)[-1] %}
                    <a href="{{ url_for('serve_asset', filename=filename) }}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #e2e8f0; color: #0f172a; text-decoration: none; font-size: 12px;">
                      üìé {{ filename }}
                    </a>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if settings.detail_references %}
              <div>
                <h4 style="margin: 0 0 6px; font-size: 13px;">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h4>
                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                  {% for ref in settings.detail_references %}
                    {% set filename = ref.rsplit('/', 1)[-1] %}
                    <a href="{{ url_for('serve_asset', filename=filename) }}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #e2e8f0; color: #0f172a; text-decoration: none; font-size: 12px;">
                      üìé {{ filename }}
                    </a>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      {% endif %}

      <div id="prompt-blocks" class="grid">
        <div class="block-field">
          <label>–ü—Ä–æ–º—Ç –ª–∏—Å—Ç–∞ 1</label>
          <textarea name="sheet_prompts" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –æ–±—â–∏–π —Å–µ—Ç—Ç–∏–Ω–≥ —Å—Ü–µ–Ω—ã"></textarea>
        </div>
        <div class="block-field">
          <label>–ü—Ä–æ–º—Ç –ª–∏—Å—Ç–∞ 2</label>
          <textarea name="sheet_prompts" rows="3" placeholder="–î–µ—Ç–∞–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Å–≤–µ—Ç–∞ –∏–ª–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã"></textarea>
        </div>
      </div>
      <div style="margin-top: 12px;">
        <button id="add-block" class="button secondary" type="button">+ –î–æ–±–∞–≤–∏—Ç—å –ª–∏—Å—Ç</button>
      </div>
    </form>

    <h2 style="margin: 28px 0 12px;">–ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</h2>
    {% if generations %}
      <div class="history">
        <div class="card gen-browser">
          <div>
            <div style="font-weight: 700; font-size: 16px;">–ü—Ä–æ–≤–æ–¥–Ω–∏–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div>
            <p style="margin: 4px 0 0; color: #475569;">–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é, —á—Ç–æ–±—ã –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–π—Ç–∏ –∫ –µ—ë –∫–∞—Ä—Ç–æ—á–∫–µ.</p>
          </div>
          <div id="gen-nav" class="gen-list">
            {% for gen in generations %}
              <button type="button" data-gen-id="{{ gen.id }}">
                <span>#{{ gen.id }}</span>
                <span style="font-size: 12px; color: #475569; display: inline-flex; gap: 6px; align-items: center;">
                  <span>{{ STATUS_LABELS.get(gen.status, gen.status) }}</span>
                  {% if gen.approved %}<span>‚òÖ</span>{% endif %}
                </span>
              </button>
            {% endfor %}
          </div>
          <button id="show-all" class="button secondary full-width" type="button">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
        </div>
        <div class="grid">
        {% for gen in generations %}
          <div class="card generation-card" data-gen-card="{{ gen.id }}" id="generation-{{ gen.id }}">
            <div class="header-actions">
              <div>
                <div style="font-weight: 700; font-size: 16px;">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è #{{ gen.id }}</div>
                <div class="chip-row">
                  <span class="chip">{{ gen.aspect_ratio }}</span>
                  <span class="chip">{{ gen.resolution }}</span>
                  {% if gen.approved %}<span class="chip">‚òÖ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å</span>{% endif %}
                </div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <form method="post" action="{{ url_for('export_pdf_route', generation_id=gen.id) }}">
                  <button class="button secondary" type="submit" {% if not gen.approved %}disabled{% endif %}>–°–¥–µ–ª–∞—Ç—å PDF</button>
                </form>
                <span class="badge {{ gen.status }}" data-status-badge>{{ STATUS_LABELS.get(gen.status, gen.status) }}</span>
              </div>
            </div>

            {% if gen.status in ['generating', 'regenerating'] %}
              <div class="status-note" style="margin-top: 8px;">
                üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è ‚Äî –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –ª–∏—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã.
              </div>
            {% endif %}

            {% set ready_count = gen.images | selectattr('status', 'in', ['ready', 'approved']) | list | length %}
            <div class="status-note" data-gen-progress="{{ gen.id }}" style="margin-top: 8px;">
              üì• –ó–∞–≥—Ä—É–∂–µ–Ω–æ <strong data-ready-count>{{ ready_count }}</strong> / {{ gen.images|length }} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.
            </div>

            <div class="grid" style="margin-top: 8px;">
              <div>
                {% for prompt in gen.sheet_prompts %}
                    <div class="sheet-prompt">
                      <h4>–ü—Ä–æ–º—Ç –ª–∏—Å—Ç–∞ {{ loop.index }}</h4>
                      <p>{{ prompt }}</p>
                    </div>
                  {% endfor %}
                {% if gen.background_references %}
                  <div style="margin-top: 12px;">
                    <h4 style="margin: 0 0 6px; font-size: 13px;">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã —Ñ–æ–Ω–∞</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      {% for ref in gen.background_references %}
                        {% set filename = ref.rsplit('/', 1)[-1] %}
                        <a href="{{ url_for('serve_asset', filename=filename) }}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #e2e8f0; color: #0f172a; text-decoration: none; font-size: 12px;">
                          üìé {{ filename }}
                        </a>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
                {% if gen.detail_references %}
                  <div style="margin-top: 12px;">
                    <h4 style="margin: 0 0 6px; font-size: 13px;">–†–µ—Ñ–µ—Ä–µ–Ω—Å—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                      {% for ref in gen.detail_references %}
                        {% set filename = ref.rsplit('/', 1)[-1] %}
                        <a href="{{ url_for('serve_asset', filename=filename) }}" target="_blank" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; background: #e2e8f0; color: #0f172a; text-decoration: none; font-size: 12px;">
                          üìé {{ filename }}
                        </a>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
                {% if gen.text_parts %}
                  <div style="margin-top: 10px;">
                    <h4 style="margin: 0 0 6px; font-size: 13px;">–¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –º–æ–¥–µ–ª–∏</h4>
                    <ul style="margin: 0 0 4px 18px; color: #475569;">
                      {% for text in gen.text_parts %}
                        <li>{{ text }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}
            </div>
            <div class="preview">
              {% set images = gen.images %}
              {% if images %}
                <div class="preview-grid">
                  {% for image in images %}
                    <div class="image-card" data-image-card="{{ image.index }}" data-gen-id="{{ gen.id }}" data-image-status="{{ image.status }}" data-image-approved="{{ 'true' if image.approved else 'false' }}">
                      <div class="image-visual" data-image-visual data-image-index="{{ image.index }}">
                        {% if image.exists %}
                          <img data-preview-img src="{{ url_for('serve_asset', filename=image.asset_name) }}" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç –ª–∏—Å—Ç–∞ {{ loop.index }}">
                        {% else %}
                          <div class="placeholder">–§–∞–π–ª {{ image.filename }} –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—É—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é.</div>
                        {% endif %}
                      </div>
                      <div class="chip-row">
                        <span class="chip" data-image-status>{{ STATUS_LABELS.get(image.status, image.status) }}</span>
                        {% if image.approved %}<span class="chip" data-image-approved>‚òÖ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å</span>{% endif %}
                      </div>
                      <div class="actions">
                        <form method="post" action="{{ url_for('approve_image', generation_id=gen.id, image_index=image.index) }}">
                          <button class="button" type="submit" data-action-approve {% if image.approved or image.status != 'ready' or progress.active %}disabled{% endif %}>üëç –ê–ø—Ä—É–≤</button>
                        </form>
                        <form method="post" action="{{ url_for('regenerate_image', generation_id=gen.id, image_index=image.index) }}" style="display: flex; gap: 8px; align-items: center;">
                          <input name="api_key" type="password" placeholder="API key (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" value="{{ settings.api_key }}" style="width: 180px;">
                          <button class="button secondary" type="submit" data-action-regenerate {% if image.status in ['generating', 'regenerating', 'pending'] or progress.active %}disabled{% endif %}>‚Üª –†–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                        </form>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="placeholder">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</div>
              {% endif %}
            </div>
          </div>
          </div>
        {% endfor %}
      </div>
      </div>
    {% else %}
      <p style="color: #94a3b8;">–ü–æ–∫–∞ –Ω–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–π. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–º—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é¬ª.</p>
    {% endif %}

    <div id="lightbox" class="lightbox">
      <button class="close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">√ó</button>
      <img id="lightbox-image" src="" alt="–ü—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
    </div>

    <script>
      const blocksContainer = document.getElementById('prompt-blocks');
      const addBlockButton = document.getElementById('add-block');
      const progressBar = document.getElementById('progress-bar');
      const progressTotal = document.getElementById('progress-total');
      const progressCompleted = document.getElementById('progress-completed');
      const progressActive = document.getElementById('progress-active');
      const generateForm = document.querySelector('form[action="{{ url_for('generate') }}"]');
      const formLiveStatus = document.getElementById('form-live-status');
      const startGenerationButton = document.getElementById('start-generation');
      const lightbox = document.getElementById('lightbox');
      const lightboxImage = document.getElementById('lightbox-image');
      const lightboxClose = lightbox?.querySelector('.close');
      let isQueueBusy = {{ 'true' if progress.active else 'false' }};

      addBlockButton.addEventListener('click', () => {
        const index = blocksContainer.querySelectorAll('.block-field').length + 1;
        const wrapper = document.createElement('div');
        wrapper.className = 'block-field';
        wrapper.innerHTML = `
          <label>–ü—Ä–æ–º—Ç –ª–∏—Å—Ç–∞ ${index}</label>
          <textarea name="sheet_prompts" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –ª–∏—Å—Ç–∞"></textarea>
        `;
        blocksContainer.appendChild(wrapper);
      });

      const nav = document.getElementById('gen-nav');
      const showAllButton = document.getElementById('show-all');
      const generationCards = Array.from(document.querySelectorAll('[data-gen-card]'));

      const setActiveGeneration = (id = null) => {
        const idStr = id ? String(id) : null;
        generationCards.forEach((card) => {
          const isActive = !idStr || card.dataset.genCard === idStr;
          card.classList.toggle('hidden-card', !isActive);
          if (isActive && idStr) {
            card.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
        if (nav) {
          nav.querySelectorAll('[data-gen-id]').forEach((button) => {
            button.classList.toggle('active', idStr === button.dataset.genId);
          });
        }
      };

      if (nav) {
        nav.addEventListener('click', (event) => {
          const target = event.target.closest('[data-gen-id]');
          if (target) {
            setActiveGeneration(target.dataset.genId);
          }
        });
      }

      if (showAllButton) {
        showAllButton.addEventListener('click', () => setActiveGeneration(null));
      }

      const syncImageActions = (card, image) => {
        const approveButton = card.querySelector('[data-action-approve]');
        if (approveButton) {
          approveButton.disabled = isQueueBusy || image.approved || image.status !== 'ready';
        }

        const regenerateButton = card.querySelector('[data-action-regenerate]');
        if (regenerateButton) {
          const isImageBusy = ['generating', 'regenerating', 'pending'].includes(image.status);
          regenerateButton.disabled = isQueueBusy || isImageBusy;
        }
      };

      const setQueueBusy = (busy) => {
        isQueueBusy = busy;
        if (startGenerationButton) {
          startGenerationButton.disabled = busy;
        }
        document.querySelectorAll('[data-image-card]').forEach((card) => {
          const status = card.dataset.imageStatus;
          const approved = card.dataset.imageApproved === 'true';
          syncImageActions(card, { status, approved });
        });

        if (formLiveStatus) {
          formLiveStatus.style.display = busy ? 'inline-flex' : 'none';
          if (busy) {
            formLiveStatus.innerHTML = '<span class="live-dot"></span> –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞, –∂–¥—ë–º –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...';
          }
        }
      };

      const setProgress = (progress) => {
        if (!progress || !progressTotal || !progressCompleted || !progressBar || !progressActive) return;
        progressTotal.textContent = progress.total ?? 0;
        progressCompleted.textContent = progress.completed ?? 0;
        const percent = progress.total ? Math.floor((progress.completed / progress.total) * 100) : 0;
        progressBar.style.width = `${percent}%`;

        const isBusy = (progress.active ?? 0) > 0;
        progressActive.textContent = isBusy ? `–í —Ä–∞–±–æ—Ç–µ: ${progress.active}` : '–û—á–µ—Ä–µ–¥—å —Å–≤–æ–±–æ–¥–Ω–∞';
        progressActive.className = `badge ${isBusy ? 'generating' : 'ready'}`;
        setQueueBusy(isBusy);
      };

      const updateImageCard = (card, image, statusLabels) => {
        const statusChip = card.querySelector('[data-image-status]');
        if (statusChip) {
          statusChip.textContent = statusLabels[image.status] || image.status;
        }

        card.dataset.imageStatus = image.status;
        card.dataset.imageApproved = image.approved ? 'true' : 'false';

        const approvedChip = card.querySelector('[data-image-approved]');
        if (image.approved && !approvedChip) {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.dataset.imageApproved = '';
          chip.textContent = '‚òÖ –ø–æ–Ω—Ä–∞–≤–∏–ª–æ—Å—å';
          card.querySelector('.chip-row')?.appendChild(chip);
        } else if (!image.approved && approvedChip) {
          approvedChip.remove();
        }

        const visual = card.querySelector('[data-image-visual]');
        if (visual) {
          if (image.exists && image.asset_url) {
            let img = visual.querySelector('img');
            if (!img) {
              img = document.createElement('img');
              img.dataset.previewImg = '';
              img.alt = '–†–µ–∑—É–ª—å—Ç–∞—Ç –ª–∏—Å—Ç–∞';
              visual.innerHTML = '';
              visual.appendChild(img);
            }
            img.src = image.asset_url;
            if (!img.dataset.previewBound) {
              img.dataset.previewBound = 'true';
              img.addEventListener('click', () => {
                if (!lightbox || !lightboxImage) return;
                lightboxImage.src = img.src;
                lightbox.classList.add('visible');
              });
            }
          }
        }

        syncImageActions(card, image);
      };

      const setGenerationProgress = (genId, ready, total) => {
        const progressNote = document.querySelector(`[data-gen-progress="${genId}"]`);
        if (progressNote) {
          progressNote.querySelector('[data-ready-count]').textContent = ready;
          if (total !== undefined) {
            progressNote.innerHTML = `üì• –ó–∞–≥—Ä—É–∂–µ–Ω–æ <strong data-ready-count>${ready}</strong> / ${total} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.`;
          }
        }
      };

      const updateGenerationCard = (gen, statusLabels) => {
        const card = document.querySelector(`[data-gen-card="${gen.id}"]`);
        if (!card) return;

        const badge = card.querySelector('[data-status-badge]');
        if (badge) {
          badge.textContent = gen.status_label;
          badge.className = `badge ${gen.status}`;
        }

        setGenerationProgress(gen.id, gen.ready, gen.total);

        if (Array.isArray(gen.images)) {
          gen.images.forEach((image) => {
            const imageCard = card.querySelector(`[data-image-card="${image.index}"]`);
            if (imageCard) {
              updateImageCard(imageCard, image, statusLabels);
            }
          });
        }
      };

      const fetchStatus = async () => {
        try {
          const response = await fetch('/status', { cache: 'no-store' });
          if (!response.ok) return;
          const data = await response.json();
          setProgress(data.progress);
          if (Array.isArray(data.generations)) {
            data.generations.forEach((gen) => updateGenerationCard(gen, {{ STATUS_LABELS | tojson }}));
          }
        } catch (error) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', error);
        }
      };

      const startPolling = () => {
        fetchStatus();
        setInterval(fetchStatus, 4000);
      };

      const attachPreviewHandlers = () => {
        document.querySelectorAll('[data-preview-img]').forEach((img) => {
          img.addEventListener('click', () => {
            if (!lightbox || !lightboxImage) return;
            lightboxImage.src = img.src;
            lightbox.classList.add('visible');
          });
        });
      };

      attachPreviewHandlers();

      document.querySelectorAll('[data-image-card]').forEach((card) => {
        syncImageActions(card, {
          status: card.dataset.imageStatus,
          approved: card.dataset.imageApproved === 'true',
        });
      });

      setQueueBusy(isQueueBusy);

      if (lightbox && lightboxClose) {
        lightbox.addEventListener('click', (event) => {
          if (event.target === lightbox || event.target === lightboxClose) {
            lightbox.classList.remove('visible');
          }
        });
      }

      if (generateForm && formLiveStatus) {
        generateForm.addEventListener('submit', () => {
          setQueueBusy(true);
        });
      }

      startPolling();
    </script>
  </body>
</html>
